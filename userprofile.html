<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MaxAI - User Profile</title>

    <link rel="stylesheet" href="css/userprofile.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/storage.js"></script>
    <style>
      .user-content {
        display: grid;
        gap: 24px;
      }
      .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
      }
      .detail-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        padding: 18px;
      }
      .detail-card h3 {
        margin-bottom: 12px;
      }
      .user-form .form-group {
        display: grid;
        gap: 6px;
        margin-bottom: 12px;
      }
      .user-form input {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        color: #fff;
        padding: 10px 12px;
        border-radius: 10px;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .btn-ghost {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.18);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: #fff;
        border: 1px solid rgba(239, 68, 68, 0.5);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 10px 25px rgba(239, 68, 68, 0.25);
      }
      .btn-danger:hover {
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body>
    <nav>
      <div class="nav-container">
        <a href="home.html" aria-label="Go to Home">
          <img src="img/logo.svg" class="logo" alt="MaxAI" />
        </a>

        <div class="nav-links">
          <a href="home.html" class="nav-link">Home</a>
          <a href="modules.html" class="nav-link">Modules</a>
          <a href="flashcard.html" class="nav-link">Flashcard</a>
          <a href="quiz.html" class="nav-link">Quiz</a>
          <a href="about.html" class="nav-link">About</a>
        </div>

        <div class="nav-actions">
          <div class="profile-menu">
            <button
              type="button"
              class="profile-btn"
              aria-label="Profile"
              aria-expanded="false"
            >
              <i class="fas fa-user"></i>
            </button>
            <div class="menu">
              <a href="userprofile.html"
                ><i class="fas fa-user-circle"></i> Profile</a
              >
              <a href="login.html"
                ><i class="fas fa-right-from-bracket"></i> Logout</a
              >
            </div>
          </div>
        </div>

        <div class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </div>
      </div>
    </nav>
    <script>
      (function () {
        const menu = document.querySelector(".profile-menu");
        if (!menu) return;
        const btn = menu.querySelector(".profile-btn");
        btn?.setAttribute("aria-expanded", "false");
        btn?.addEventListener("click", function (e) {
          e.preventDefault();
          const open = menu.classList.toggle("open");
          btn.setAttribute("aria-expanded", String(open));
        });
        document.addEventListener("click", function (e) {
          if (!menu.contains(e.target)) {
            menu.classList.remove("open");
            btn?.setAttribute("aria-expanded", "false");
          }
        });
      })();
    </script>

    <section id="user-details" class="user-profile">
      <div class="container">
        <div class="section-header">
          <h2>User Profile</h2>
        </div>

        <div class="user-content">
          <div class="profile-section">
            <div class="profile-image">
              <img
                src="img/profile-pic.png"
                alt="Profile Picture"
                id="profile-pic"
              />
              <div class="image-upload">
                <label for="file-input" class="upload-btn">
                  <i class="fas fa-camera"></i>
                </label>
                <input
                  type="file"
                  id="file-input"
                  accept="image/png, image/jpg, image/jpeg, image/svg"
                  style="display: none"
                />
              </div>
            </div>

            <div class="profile-info">
              <h3 id="display-name">Justin</h3>
              <p class="user-role">Learner</p>
              <p class="user-email" id="display-email">justin@example.com</p>
            </div>
          </div>

          <div class="details-grid">
            <div class="detail-card">
              <h3>Personal Information</h3>
              <form class="user-form" id="user-form">
                <div class="form-group">
                  <label for="username">Username</label>
                  <input type="text" id="username" value="Justin" required />
                </div>
                <div class="form-group">
                  <label for="email">Email</label>
                  <input
                    type="email"
                    id="email"
                    value="justin@example.com"
                    required
                  />
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
              </form>
            </div>

            <div class="detail-card">
              <h3>Change Password</h3>
              <form id="password-form" class="user-form">
                <div class="form-group">
                  <label for="curPassword">Current Password</label>
                  <input
                    type="password"
                    id="curPassword"
                    placeholder="Leave empty if setting for first time"
                  />
                </div>
                <div class="form-group">
                  <label for="newPassword">New Password</label>
                  <input
                    type="password"
                    id="newPassword"
                    minlength="8"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="confirmPassword">Confirm New Password</label>
                  <input
                    type="password"
                    id="confirmPassword"
                    minlength="8"
                    required
                  />
                </div>
                <button type="submit" class="btn-primary">
                  <i class="fas fa-key"></i> Update Password
                </button>
                <div id="pw-feedback" class="form-note"></div>
              </form>
            </div>
            <div class="detail-card">
              <h3>Danger Zone</h3>
              <p class="form-note">
                Deleting your account will remove your profile and learning
                progress on this device.
              </p>
              <br />
              <div class="actions">
                <button id="delete-account" class="btn-danger">
                  <i class="fas fa-trash"></i> Delete Account
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="footer-bottom">
        <p>
          &copy; 2025 MaxAI |
          <a href="mailto:rachellwanggg@gmail.com">andrianateam.com</a>
        </p>
      </div>
    </footer>

    <script>
      // Mobile menu toggle
      document
        .querySelector(".mobile-menu-btn")
        ?.addEventListener("click", function () {
          document.querySelector(".nav-links")?.classList.toggle("active");
        });

      // Load current user and populate profile
      (function () {
        try {
          const store = window.StorageUtil;
          const current = store.getJSON("currentUser", null);
          if (!current || !current.email) {
            // Not logged in; redirect to login
            window.location.href = "login.html";
            return;
          }
          const users = store.getJSON("users", []);
          const user =
            users.find((u) => u.id === current.id) ||
            users.find(
              (u) =>
                (u.email || "").toLowerCase() ===
                String(current.email).toLowerCase()
            );
          const username = (user && user.username) || current.username || "";
          const email = (user && user.email) || current.email || "";
          const avatar = user && user.avatar ? user.avatar : null;

          const dn = document.getElementById("display-name");
          if (dn) dn.textContent = username || "";
          const de = document.getElementById("display-email");
          if (de) de.textContent = email || "";
          const un = document.getElementById("username");
          if (un) un.value = username || "";
          const em = document.getElementById("email");
          if (em) em.value = email || "";
          const pic = document.getElementById("profile-pic");
          if (pic && avatar) {
            pic.src = avatar;
          }
        } catch (e) {
          console.error(e);
        }
      })();

      // Profile image upload preview + persist to localStorage (compressed)
      document
        .getElementById("file-input")
        ?.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            const dataUrl = ev.target.result;
            // Downscale to max 256x256 to keep storage small
            const imgEl = new Image();
            imgEl.onload = function () {
              const maxSize = 256;
              let { width, height } = imgEl;
              const scale = Math.min(1, maxSize / Math.max(width, height));
              const w = Math.max(1, Math.round(width * scale));
              const h = Math.max(1, Math.round(height * scale));
              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(imgEl, 0, 0, w, h);
              const out = canvas.toDataURL("image/jpeg", 0.85);

              const img = document.getElementById("profile-pic");
              if (img) img.src = out;

              try {
                const store = window.StorageUtil;
                const current = store.getJSON("currentUser", null);
                if (!current) return;
                const users = store.getJSON("users", []);
                const idx = users.findIndex((u) => u.id === current.id);
                if (idx >= 0) {
                  users[idx].avatar = out;
                  store.setJSON("users", users);
                }
              } catch (err) {
                console.error(err);
              }
            };
            imgEl.src = dataUrl;
          };
          reader.readAsDataURL(file);
        });

      // Save personal info and persist to localStorage
      document
        .getElementById("user-form")
        ?.addEventListener("submit", function (e) {
          e.preventDefault();
          const name = document.getElementById("username")?.value.trim() || "";
          const email =
            document.getElementById("email")?.value.trim().toLowerCase() || "";

          if (!name || !email) {
            Swal.fire({
              icon: "warning",
              title: "Missing info",
              text: "Please enter both name and email.",
            });
            return;
          }
          if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            Swal.fire({
              icon: "error",
              title: "Invalid email",
              text: "Please enter a valid email address.",
            });
            return;
          }

          try {
            const store = window.StorageUtil;
            const current = store.getJSON("currentUser", null);
            if (!current) throw new Error("Not logged in");
            const users = store.getJSON("users", []);
            const idx = users.findIndex((u) => u.id === current.id);
            if (idx === -1) throw new Error("User not found");

            // Ensure email uniqueness (exclude current user)
            const taken = users.some(
              (u, i) => i !== idx && (u.email || "").toLowerCase() === email
            );
            if (taken) {
              Swal.fire({
                icon: "error",
                title: "Email in use",
                text: "Another account already uses this email.",
              });
              return;
            }

            users[idx].username = name;
            users[idx].email = email;
            store.setJSON("users", users);
            store.setJSON("currentUser", {
              id: users[idx].id,
              username: users[idx].username,
              email: users[idx].email,
            });

            const dn = document.getElementById("display-name");
            if (dn) dn.textContent = name;
            const de = document.getElementById("display-email");
            if (de) de.textContent = email;

            Swal.fire({
              icon: "success",
              title: "Saved",
              text: "Profile updated.",
            });
          } catch (err) {
            console.error(err);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Could not save changes.",
            });
          }
        });

      // Change password and persist to the same user record
      document
        .getElementById("password-form")
        ?.addEventListener("submit", function (e) {
          e.preventDefault();
          const store = window.StorageUtil;
          const users = store.getJSON("users", []);
          const current = store.getJSON("currentUser", null);
          const idx = users.findIndex((u) => current && u.id === current.id);
          const saved = idx >= 0 ? users[idx].password || "" : "";
          const cur = document.getElementById("curPassword")?.value || "";
          const npw = document.getElementById("newPassword")?.value || "";
          const cfm = document.getElementById("confirmPassword")?.value || "";
          const fb = document.getElementById("pw-feedback");
          const setMsg = (cls, msg) => {
            if (fb) {
              fb.classList.remove("ok", "err");
              fb.classList.add(cls);
              fb.textContent = msg;
            }
          };
          if (npw.length < 8) {
            setMsg("err", "Password must be at least 8 characters.");
            return;
          }
          if (npw !== cfm) {
            setMsg("err", "New password and confirmation do not match.");
            return;
          }
          if (saved && cur !== saved) {
            setMsg("err", "Current password is incorrect.");
            return;
          }
          try {
            if (idx >= 0) {
              users[idx].password = npw;
              store.setJSON("users", users);
            }
          } catch (_) {}
          // Clear fields and confirm
          const cp = document.getElementById("curPassword");
          if (cp) cp.value = "";
          document.getElementById("newPassword").value = "";
          document.getElementById("confirmPassword").value = "";
          setMsg("ok", "Password updated.");
        });

      // Delete account: remove user + all per-user progress keys, then sign out
      document
        .getElementById("delete-account")
        ?.addEventListener("click", function () {
          Swal.fire({
            title: "Delete account?",
            text: "This will permanently remove your profile and learning progress on this device.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Delete",
            confirmButtonColor: "#dc2626",
          }).then(function (res) {
            if (!res.isConfirmed) return;
            try {
              const S = window.StorageUtil;
              const current = S.getJSON("currentUser", null);
              if (!current) {
                window.location.href = "login.html";
                return;
              }
              // Remove from users list
              const users = S.getJSON("users", []);
              const filtered = Array.isArray(users)
                ? users.filter((u) => u && u.id !== current.id)
                : [];
              S.setJSON("users", filtered);

              // Remove all keys scoped to this user (suffix ::scope)
              const scope = (function () {
                try {
                  return String(
                    current.id || current.email || current.username || "guest"
                  );
                } catch (_) {
                  return "guest";
                }
              })();
              const suffix = "::" + scope;
              try {
                const keys = [];
                for (let i = 0; i < localStorage.length; i++) {
                  const k = localStorage.key(i);
                  if (k) keys.push(k);
                }
                keys.forEach((k) => {
                  if (k.endsWith(suffix)) localStorage.removeItem(k);
                });
              } catch (_) {}

              // Clear session
              try {
                localStorage.removeItem("currentUser");
              } catch (_) {}
              S.setJSON("currentUser", null);

              Swal.fire({
                icon: "success",
                title: "Account deleted",
                text: "Your account was removed.",
              });
              setTimeout(function () {
                window.location.href = "login.html";
              }, 800);
            } catch (e) {
              console.error(e);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Could not delete account.",
              });
            }
          });
        });
    </script>
  </body>
</html>
